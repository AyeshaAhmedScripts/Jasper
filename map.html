{% extends "base.html" %}
{% block title %}🧭 Apocalypse Shared Map{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Creepster&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body, html {
    margin: 0 !important;
    padding: 0 !important;
    background: #1e1e2f;
    font-family: 'Arial', sans-serif;
    color: #e8e8e8;
    height: 100%;
    overflow: hidden;
  }

  /* Override container or wrapper from base.html */
  main, .container, .content, .page-wrapper {
    margin: 0 !important;
    padding: 0 !important;
    max-width: 100% !important;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    position: relative;
  }

  #map {
    height: 100vh;
    width: 100vw;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 0;
  }

  #controls, #legend, #filterBox {
    position: fixed;
    background: rgba(30,30,47,0.95);
    border-radius: 8px;
    z-index: 1001;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    display: block;
  }

  #controls {
    bottom: 20px;
    left: 20px;
    padding: 10px;
    width: 220px;
  }

  #legend {
    bottom: 30px;
    right: 30px;
    padding: 10px;
    font-size: 14px;
    line-height: 1.4;
    border: 1px solid #999;
  }

  #filterBox {
    top: 20px;
    right: 30px;
    padding: 8px;
    width: 180px;
  }

  select, button, input[type="text"] {
    width: 100%;
    margin-top: 6px;
    padding: 6px;
    font-size: 14px;
    background: #2a2a3f;
    border: 1px solid #555;
    color: #e8e8e8;
    border-radius: 4px;
  }

  button:hover {
    background: #3a3a5f;
  }

  .delete-btn, .vote-btn {
    cursor: pointer;
    font-size: 12px;
    display: inline-block;
    margin-top: 4px;
  }

  .vote-btn {
    margin-right: 8px;
  }

  .leaflet-control-zoom {
    top: 80px !important;
  }
</style>


<a href="/panel" style="position:absolute;top:20px;left:35px;z-index:1001;background:#2a2a3f;padding:8px 12px;border-radius:6px;color:white;text-decoration:none;border:1px solid #888;">📊 Panel</a>

<div id="controls">
  <label for="tagType">Choose Tag:</label>
  <select id="tagType" onchange="toggleCustomInput(this.value)">
    <option value="✅ Safe">✅ Safe</option>
    <option value="📞 Medical Emergency">📞 Medical Emergency</option>
    <option value="❌ Dangerous">❌ Dangerous</option>
    <option value="🍔 Food">🍔 Food</option>
    <option value="💧 Water">💧 Water</option>
    <option value="🏠 Shelter">🏠 Shelter</option>
    <option value="⚠️ Caution Zone">⚠️ Caution Zone</option>
    <option value="🏷️ Custom Tag">🏷️ Custom Tag</option>
  </select>
  <input type="text" id="customTagInput" placeholder="Enter custom tag" style="display:none;" /><br>
  <button onclick="enableTagging()">➕ Add Tag (Tap Map)</button>
  <button onclick="tagCurrentLocation()">📍 Tag My Location</button>
  <button onclick="navigateToNearest()">🗺️ Nearest Safe/MED</button>
  <hr style="margin:8px 0;">
  <label for="radiusControl">Adjust Boundary Radius:</label>
  <input type="range" id="radiusControl" min="100" max="5000" step="100" value="2500" oninput="updateRadius(this.value)">
  <span id="radiusValue">2500</span> meters
  <button onclick="saveRadius()">💾 Save Radius</button>
</div>

<div id="legend">
  <strong>🗝️ Tag Legend</strong>
  <ul style="list-style:none; padding:4px 0 0 0; margin:0;">
    <li>✅ Safe</li><li>📞 Medical Emergency</li><li>❌ Dangerous</li><li>🍔 Food</li><li>💧 Water</li><li>🏠 Shelter</li><li>⚠️ Caution Zone</li><li>🏷️ Custom Tag</li>
  </ul>
</div>

<div id="filterBox">
  <label for="filterType">Filter:</label>
  <select id="filterType" onchange="applyFilter()">
    <option value="all">All</option>
    <option value="✅ Safe">✅ Safe</option>
    <option value="📞 Medical Emergency">📞 Medical Emergency</option>
    <option value="❌ Dangerous">❌ Dangerous</option>
    <option value="🍔 Food">🍔 Food</option>
    <option value="💧 Water">💧 Water</option>
    <option value="🏠 Shelter">🏠 Shelter</option>
    <option value="⚠️ Caution Zone">⚠️ Caution Zone</option>
    <option value="🏷️ Custom Tag">🏷️ Custom Tag</option>
  </select>
</div>

<div id="map"></div>



<script>
let map = L.map('map').setView([33.6844, 73.0479], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

let userLatLng = null;
let waypointLine = null;
let userCircle = null;
let taggingEnabled = false;
const tagMarkers = [];
const userId = "user-123";
const offlineQueueKey = "offlineTags";

const tagIcons = {
  "✅ Safe": "https://cdn-icons-png.flaticon.com/512/190/190411.png",
  "📞 Medical Emergency": "https://cdn-icons-png.flaticon.com/512/483/483947.png",
  "❌ Dangerous": "https://cdn-icons-png.flaticon.com/512/463/463612.png",
  "🍔 Food": "https://cdn-icons-png.flaticon.com/512/1046/1046784.png",
  "💧 Water": "https://openmoji.org/data/color/svg/1F4A7.svg",
  "🏠 Shelter": "https://cdn-icons-png.flaticon.com/512/1946/1946436.png",
  "⚠️ Caution Zone": "https://cdn-icons-png.flaticon.com/512/595/595067.png",
  "🏷️ Custom Tag": "https://cdn-icons-png.flaticon.com/512/484/484167.png"
};

navigator.geolocation.getCurrentPosition(successLocation, errorLocation, {
  enableHighAccuracy: true,
  timeout: 10000,
  maximumAge: 0
});

function toggleCustomInput(value) {
  document.getElementById("customTagInput").style.display = value === "🏷️ Custom Tag" ? "block" : "none";
}

function successLocation(pos) {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  const radius = localStorage.getItem("savedRadius") || 2500;
  userLatLng = L.latLng(lat, lng);

  const icon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png", iconSize: [25, 25] });
  L.marker([lat, lng], { icon }).addTo(map).bindPopup("📍 You are here").openPopup();

  userCircle = L.circle([lat, lng], {
    radius: Number(radius),
    color: "#007bff",
    fillColor: "#007bff",
    fillOpacity: 0.2
  }).addTo(map);

  document.getElementById("radiusControl").value = radius;
  document.getElementById("radiusValue").textContent = radius;
  map.setView([lat, lng], 17);
  checkNearbyDangerousTags();
}

function errorLocation() {
  map.setView([33.6844, 73.0479], 13);
}

function enableTagging() {
  taggingEnabled = true;
  alert("Click on the map to place your tag.");
}

map.on("click", e => {
  if (taggingEnabled) {
    addTagToServer(e.latlng.lat, e.latlng.lng);
    taggingEnabled = false;
  }
});

function tagCurrentLocation() {
  navigator.geolocation.getCurrentPosition(pos => {
    addTagToServer(pos.coords.latitude, pos.coords.longitude);
  }, () => alert("Location failed."));
}

function addTagToServer(lat, lng) {
  let tag = document.getElementById("tagType").value;
  if (tag === "🏷️ Custom Tag") {
    const custom = document.getElementById("customTagInput").value.trim();
    if (!custom) return alert("Enter a custom tag name.");
    tag = `🏷️ ${custom}`;
    tagIcons[tag] = tagIcons["🏷️ Custom Tag"];
  }

  const payload = { user_id: userId, tag, lat, lng, timestamp: Date.now() };

  fetch("/add-tag", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => addMarker(data))
  .catch(() => {
    alert("Offline: saved locally");
    const q = JSON.parse(localStorage.getItem(offlineQueueKey) || "[]");
    q.push(payload);
    localStorage.setItem(offlineQueueKey, JSON.stringify(q));
    addMarker({ ...payload, id: Date.now(), status: "Pending" });
  });
}

function addMarker(tagObj) {
  tagObj.id = tagObj.id || `${tagObj.user_id}-${tagObj.lat}-${tagObj.lng}-${tagObj.timestamp}`;
  const icon = L.icon({ iconUrl: tagIcons[tagObj.tag] || tagIcons["🏷️ Custom Tag"], iconSize: [32, 32] });
  const marker = L.marker([tagObj.lat, tagObj.lng], { icon }).addTo(map);
  marker._tagType = tagObj.tag;
  tagMarkers.push(marker);

  marker.on("click", () => {
    if (!userLatLng) return alert("User location unknown.");

    const tagLatLng = L.latLng(tagObj.lat, tagObj.lng);
    const dist = map.distance(userLatLng, tagLatLng).toFixed(0);

    // Draw or replace waypoint line
    if (waypointLine) map.removeLayer(waypointLine);
    waypointLine = L.polyline([userLatLng, tagLatLng], {
      color: "cyan",
      weight: 3,
      dashArray: "5,10"
    }).addTo(map);

    const ageSec = (Date.now() - tagObj.timestamp) / 1000;
    const ageText = ageSec < 60 ? "just now" :
      ageSec < 3600 ? `${Math.floor(ageSec / 60)}m ago` :
      ageSec < 86400 ? `${Math.floor(ageSec / 3600)}h ago` :
      `${Math.floor(ageSec / 86400)}d ago`;

    let popup = `<strong>${tagObj.tag}</strong><br>Status: ${tagObj.status || "Pending"}<br>📏 Distance: ${dist} meters<br>🕒 ${ageText}`;
    if (tagObj.user_id === userId)
      popup += `<br><span class="delete-btn" onclick="deleteTag('${tagObj.id}')">🗑️ Remove</span>`;
    popup += `<br><span class="vote-btn" onclick="vote('${tagObj.id}',1)">👍 ${tagObj.up || 0}</span>
              <span class="vote-btn" onclick="vote('${tagObj.id}',-1)">👎 ${tagObj.down || 0}</span>`;
    if (tagObj.status === "Verified") popup += `<br>✔️ Verified`;

    marker.bindPopup(popup).openPopup();

    // Check danger zone
    if (tagObj.tag === "❌ Dangerous" && dist < 300) {
      userCircle.setStyle({ color: "red", fillColor: "red" });
    } else {
      checkNearbyDangerousTags();
    }
  });

  checkNearbyDangerousTags();
}

function checkNearbyDangerousTags() {
  if (!userLatLng || !userCircle) return;
  let dangerNearby = tagMarkers.some(m => m._tagType === "❌ Dangerous" && map.distance(userLatLng, m.getLatLng()) < 300);
  userCircle.setStyle({
    color: dangerNearby ? "red" : "#007bff",
    fillColor: dangerNearby ? "red" : "#007bff"
  });
}

function deleteTag(id) {
  if (!confirm("Are you sure?")) return;
  fetch(`/delete-tag/${id}`, { method: "DELETE" })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(() => alert("Delete failed."));
}

function vote(id, delta) {
  const direction = delta === 1 ? "up" : "down";
  fetch(`/vote/${id}/${direction}`, { method: "POST" })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(() => alert("Vote failed."));
}

function updateRadius(val) {
  if (userCircle) {
    userCircle.setRadius(Number(val));
    document.getElementById("radiusValue").textContent = val;
  }
}

function saveRadius() {
  const val = document.getElementById("radiusControl").value;
  localStorage.setItem("savedRadius", val);
  alert(`Radius saved: ${val}m`);
}

function applyFilter() {
  const type = document.getElementById("filterType").value;
  tagMarkers.forEach(m => {
    if (type === "all" || m._tagType === type) map.addLayer(m);
    else map.removeLayer(m);
  });
}

function navigateToNearest() {
  if (!userLatLng) return alert("Unknown location.");
  let minDist = Infinity, best = null;
  tagMarkers.forEach(m => {
    if (["✅ Safe", "📞 Medical Emergency"].includes(m._tagType)) {
      const d = map.distance(userLatLng, m.getLatLng());
      if (d < minDist) {
        minDist = d;
        best = m;
      }
    }
  });

  if (best) {
    best.openPopup();
    map.setView(best.getLatLng(), 17);
    if (waypointLine) map.removeLayer(waypointLine);
    waypointLine = L.polyline([userLatLng, best.getLatLng()], {
      color: "cyan", weight: 3, dashArray: "5,10"
    }).addTo(map);
    alert(`📏 ${minDist.toFixed(0)}m to nearest Safe/MED`);
  } else {
    alert("No nearby Safe/Medical tags found.");
  }
}

function syncOffline() {
  const queued = JSON.parse(localStorage.getItem(offlineQueueKey) || "[]");
  queued.forEach(payload => {
    fetch("/add-tag", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  });
  localStorage.removeItem(offlineQueueKey);
}

window.addEventListener("online", syncOffline);
fetch("/get-tags").then(r => r.json()).then(tags => tags.forEach(addMarker));



</script>

{% endblock %}